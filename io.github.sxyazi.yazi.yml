id: io.github.sxyazi.yazi
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.golang
command: yazi-wrapper.sh
add-extensions:
  # Needs ffmpeg to generate video preview thumbnails
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: *runtime-version
    no-autodownload: false
    autodelete: true

finish-args:
  # File manager needs access to every file
  - --filesystem=host

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin

modules:
  # For downloading themes/plugins with the `ya` package manager
  - name: git
    make-args:
      - INSTALL_SYMLINKS=1
    make-install-args:
      - INSTALL_SYMLINKS=1
    cleanup:
      - /lib/pkgconfig
      - /man
      - /share/git-gui
    sources:
      - type: archive
        url: https://www.kernel.org/pub/software/scm/git/git-2.49.0.tar.xz
        sha256: 618190cf590b7e9f6c11f91f23b1d267cd98c3ab33b850416d8758f8b5a85628
        x-checker-data:
          type: anitya
          project-id: 5350
          stable-only: true
          url-template: https://www.kernel.org/pub/software/scm/git/git-$version.tar.xz
  # For formatted json previews
  - name: jq
    config-opts:
      - --disable-maintainer-mode
      - --disable-docs
      - --disable-valgrind
      - --with-oniguruma=builtin
    sources:
      - type: git
        url: https://github.com/stedolan/jq
        tag: jq-1.7.1
        commit: 71c2ab509a8628dbbad4bc7b3f98a64aa90d3297
        x-checker-data:
          type: anitya
          project-id: 13252
          stable-only: true
          tag-template: jq-$version
      - type: script
        commands: [autoreconf -if]
        dest-filename: autogen.sh
    cleanup:
      - /bin/onig-config
      - /share/doc
      - /include
  # For generating image preview thumbnails
  - name: imagemagick
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/ImageMagick/ImageMagick.git
        tag: 7.1.1-47
        commit: 82572afc879b439cbf8c9c6f3a9ac7626adf98fb
        x-checker-data:
          type: anitya
          project-id: 1372
          stable-only: true
          tag-template: $version
    cleanup:
      - /share/doc
      - /include
  # fuzzy finder
  - name: fzf
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
    build-commands:
      - make
      # the file name is arch-dependent, so use wildcard instead
      - install -Dm00755 target/fzf* /app/bin/fzf
    sources:
      - type: git
        url: https://github.com/junegunn/fzf.git
        tag: v0.61.1
        commit: 93cb3758b5f08a6dbf30c6e3d2e1de9b0be52a63
        x-checker-data:
          type: anitya
          project-id: 15856
          stable-only: true
          tag-template: v$version
      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - modules/fzf/sources.yml
  # Recursively searching for files in the current directory using a regex
  - name: ripgrep
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/ripgrep/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/rg /app/bin/rg
    sources:
      - type: git
        url: https://github.com/BurntSushi/ripgrep.git
        tag: 14.1.1
        commit: 4649aa9700619f94cf9c66876e9549d83420e16c
        x-checker-data:
          type: anitya
          project-id: 15461
          stable-only: true
          tag-template: $version
      - modules/ripgrep/cargo-sources.json
  # Alternative of find.
  - name: fd
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/fd/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/fd /app/bin/fd
    sources:
      - type: git
        url: https://github.com/sharkdp/fd.git
        tag: v10.2.0
        commit: b19136871310b01500b4f09eadd7387b8476be47
        x-checker-data:
          type: anitya
          project-id: 373722
          stable-only: true
          tag-template: v$version
      - modules/fd/cargo-sources.json
  # For quickly jumping to another directory
  - name: zoxide
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/zoxide/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/zoxide /app/bin/zoxide
    sources:
      - type: git
        url: https://github.com/ajeetdsouza/zoxide.git
        tag: v0.9.7
        commit: d74bce3b7418ed965f5056297db8bb081a29121c
        x-checker-data:
          type: anitya
          project-id: 98400
          stable-only: true
          tag-template: v$version
      - modules/zoxide/cargo-sources.json
  # For spawning processes outside the flatpak sandbox
  - name: host-spawn
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
    build-commands:
      - ./build.sh $FLATPAK_ARCH
      # the file name is arch-dependent, so use wildcard instead
      - install -Dm00755 build/host-spawn-$FLATPAK_ARCH /app/bin/host-spawn
    sources:
      - type: git
        url: https://github.com/1player/host-spawn.git
        tag: v1.6.1
        commit: db1173ae2ef04beca8961a35c225117498263e23
        x-checker-data:
          type: anitya
          project-id: 270202
          stable-only: true
          tag-template: v$version
      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - modules/host-spawn/sources.yml
  # For previewing the content of a zip file
  - name: p7zip
    make-args:
      - 7z
    no-autogen: true
    make-install-args:
      - DEST_HOME=/app
    sources:
      - type: archive
        url: https://github.com/p7zip-project/p7zip/archive/refs/tags/v17.05.tar.gz
        sha256: d2788f892571058c08d27095c22154579dfefb807ebe357d145ab2ddddefb1a6
        x-checker-data:
          type: json
          url: https://api.github.com/repos/p7zip-project/p7zip/releases/latest
          url-query: '"https://github.com/p7zip-project/p7zip/archive/refs/tags/\($version).tar.gz"'
          version-query: .tag_name
    cleanup:
      - /share/doc
      - /man
  # For pdf previews
  - name: poppler
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DBUILD_QT6_TESTS=OFF
      - -DBUILD_CPP_TESTS=OFF
      - -DENABLE_CPP=ON
      - -DENABLE_GLIB=OFF
      - -DENABLE_QT5=OFF
      - -DENABLE_QT6=OFF
      - -DENABLE_BOOST=OFF
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-25.04.0.tar.xz
        sha256: b010c596dce127fba88532fd2f1043e55ea30601767952d0f2c0a80e7dc0da3d
        x-checker-data:
          type: anitya
          project-id: 3686
          stable-only: true
          url-template: https://poppler.freedesktop.org/poppler-$version.tar.xz
  # Main module
  - name: yazi
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/yazi/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - mkdir -p /app/lib/ffmpeg
      - install -Dm00755 target/release/yazi ${FLATPAK_DEST}/bin/yazi
      # `ya` is a package manager for themes/plugins
      - install -Dm00755 target/release/ya ${FLATPAK_DEST}/bin/ya
      # Upstream icon is 1254x1260. Shrink to 512x512 to conform to icon standard. 
      - ffmpeg -hide_banner -i assets/logo.png -vf scale=512:512 logo.png
      - install -Dm00644 logo.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      # The icon specified in the upstream dot desktop file does not play nicely with Flatpak.
      - desktop-file-edit assets/yazi.desktop --set-key=Icon --set-value="${FLATPAK_ID}"
      # Run the script to disable nerd fonts before launching Yazi.
      - desktop-file-edit assets/yazi.desktop --set-key=Exec --set-value="yazi-wrapper.sh
        %u"
      - install -Dm00644 theme-no-nerd-fonts.toml ${FLATPAK_DEST}/share/theme-no-nerd-fonts.toml
      - install -Dm00744 yazi-wrapper.sh ${FLATPAK_DEST}/bin/yazi-wrapper.sh
      - install -Dm00644 assets/yazi.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm00644 flatpak.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - type: git
        url: https://github.com/sxyazi/yazi.git
        tag: v25.4.8
        commit: 99ea3b74c4260a724b43af812df0f68ef59395b7
        x-checker-data:
          type: anitya
          project-id: 370571
          stable-only: true
          tag-template: v$version
      - type: file
        url: https://raw.githubusercontent.com/yazi-rs/assets/912912302433a613bb63458fd48d3695ae961334/flatpak.xml
        sha256: a6df8d74117678eb5e5072ccda073406a9a846676ec06ee226930a9edb0d8b0c
      - cargo-sources-yazi.json
      - type: file
        path: theme-no-nerd-fonts.toml
      - type: file
        path: yazi-wrapper.sh
